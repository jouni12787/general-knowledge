<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>أسعار الذهب — 18 و 21 قيراط (دولار/غرام)</title>
<style>
  :root{ --bg:#1c140b; --bg2:#120d07; --card:#241a0e; --ink:#fff7e6; --muted:#e8d9b3;
         --gold:#d4af37; --gold2:#b88a1a; --radius:16px; --gap:14px; }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--ink);
    background:
      radial-gradient(1100px 520px at 110% -10%, rgba(212,175,55,.18), transparent 60%),
      radial-gradient(800px 520px at -10% -10%, rgba(184,138,26,.18), transparent 60%),
      linear-gradient(180deg,var(--bg) 0%,var(--bg2) 100%);
    font-family:"Noto Naskh Arabic","Segoe UI",system-ui,-apple-system,Arial;
    min-height:100vh;
  }
  header{
    position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);
    background:linear-gradient(180deg, rgba(36,26,14,.85), rgba(28,20,11,.85));
    border-bottom:1px solid rgba(212,175,55,.35); padding:18px 16px; text-align:center;
  }
  header h1{margin:0;font-size:20px}
  header p{margin:6px 0 0;color:var(--muted);font-size:12px}
  main{max-width:980px;margin:20px auto;padding:0 16px 40px}
  .grid{display:grid;gap:var(--gap)}
  @media(min-width:900px){.grid-2{grid-template-columns:1.2fr .8fr}}
  .card{
    background:linear-gradient(180deg,#2b1f10 0%,var(--card) 100%);
    border:1px solid rgba(212,175,55,.25); border-radius:var(--radius);
    padding:16px; box-shadow:0 12px 30px rgba(0,0,0,.35);
  }
  h2{margin:0 0 10px;font-size:17px}
  label{display:block;color:var(--muted);font-size:13px;margin:0 0 6px}
  input{
    width:100%; background:#171008; color:var(--ink);
    border:1px solid rgba(212,175,55,.28); padding:12px; border-radius:12px; outline:none;
    caret-color: var(--ink);
  }
  input:focus{border-color:var(--gold); box-shadow:0 0 0 3px rgba(212,175,55,.25)}
  /* iOS safest combo: telephone type + numeric/decimal inputmode + LTR visual flow */
  .num{ direction:ltr; text-align:left; }
  .row{display:grid;gap:10px;grid-template-columns:1fr 160px;align-items:end}
  .btn{
    border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:800;
    background:linear-gradient(135deg,var(--gold),var(--gold2));color:#2b1f10;
    box-shadow:0 10px 22px rgba(212,175,55,.35);
  }
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid rgba(212,175,55,.35)}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#171008;border:1px solid rgba(212,175,55,.25);color:var(--muted);font-size:12px}
  .out{
    font-family:ui-monospace,Menlo,Consolas,monospace; white-space:pre-wrap; line-height:1.6;
    background:#171008; border:1px solid rgba(212,175,55,.22); padding:12px; border-radius:12px
  }
  .error{background:#3a120c;border:1px solid rgba(255,150,120,.6);color:#ffe1db;padding:10px;border-radius:10px;font-size:12px}
  .totals-grid{display:grid;gap:10px}
  @media(min-width:700px){.totals-grid{grid-template-columns:1fr 1fr}}
  .panel{background:#1f150a;border:1px solid rgba(212,175,55,.28);border-radius:14px;padding:12px}
  .tot{
    margin-top:10px; background:#0f0a05;border:1px solid rgba(212,175,55,.28);border-radius:12px;
    padding:10px 12px; font-size:20px; text-align:center; letter-spacing:.3px;
  }
  .mini{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>أسعار الذهب — 18 قيراط و 21 قيراط (دولار/غرام)</h1>
  <p>سعر الأونصة XAU/USD من GoldAPI (أو إدخال يدوي). الحساب مبسّط فقط.</p>
</header>

<main class="grid grid-2">
  <!-- spot -->
  <section class="card">
    <h2>سعر الأونصة بالدولار</h2>
    <div class="row" style="grid-template-columns:1fr auto">
      <div>
        <label>USD/oz (إدخال يدوي)</label>
        <input id="oz" class="num" type="tel" inputmode="decimal" placeholder="مثال: 2350" value="">
      </div>
      <button id="btnFetch" class="btn">تحديث • Refresh</button>
    </div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button class="btn ghost" id="btnCalc">احسب</button>
      <span id="meta" class="badge">—</span>
    </div>
    <div id="err" class="error" style="display:none;margin-top:10px"></div>
  </section>

  <!-- per-gram + coin -->
  <section class="card">
    <h2>الأسعار الأساسية (دولار/غرام)</h2>
    <div class="out" id="perg">بيع 18K: — / غ
شراء 18K: — / غ
بيع 21K: — / غ
شراء 21K: — / غ</div>

    <h2 style="margin-top:14px">ليرة ذهبية</h2>
    <div class="out" id="coin">ليرة — مبيع: — دولار
ليرة — شراء: — دولار
<div class="mini">مبيع = ٨ × بيع ٢١ /غ — شراء = ٨ × بيع ٢١ /غ + ٨ دولار.</div></div>
  </section>

  <!-- totals -->
  <section class="card" style="grid-column:1 / -1">
    <h2>حساب الإجمالي حسب الوزن</h2>
    <div class="totals-grid" style="margin-top:8px">
      <!-- Sell 18 -->
      <div class="panel">
        <h2>بيع 18 قيراط</h2>
        <div class="row">
          <div>
            <label>الوزن (غ)</label>
            <input id="w_s18" class="num" type="tel" inputmode="decimal" placeholder="">
          </div>
          <div style="visibility:hidden">
            <label>صياغة</label>
            <input disabled class="num" placeholder="">
          </div>
        </div>
        <div id="t_s18" class="tot">الإجمالي: —</div>
      </div>

      <!-- Buy 18 -->
      <div class="panel">
        <h2>شراء 18 قيراط</h2>
        <div class="row">
          <div>
            <label>الوزن (غ)</label>
            <input id="w_b18" class="num" type="tel" inputmode="decimal" placeholder="">
          </div>
          <div>
            <label>صياغة (0–20 $/غ)</label>
            <input id="add18" class="num" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="">
          </div>
        </div>
        <div id="t_b18" class="tot">الإجمالي: —</div>
      </div>

      <!-- Sell 21 -->
      <div class="panel">
        <h2>بيع 21 قيراط</h2>
        <div class="row">
          <div>
            <label>الوزن (غ)</label>
            <input id="w_s21" class="num" type="tel" inputmode="decimal" placeholder="">
          </div>
          <div style="visibility:hidden">
            <label>صياغة</label>
            <input disabled class="num" placeholder="">
          </div>
        </div>
        <div id="t_s21" class="tot">الإجمالي: —</div>
      </div>

      <!-- Buy 21 -->
      <div class="panel">
        <h2>شراء 21 قيراط</h2>
        <div class="row">
          <div>
            <label>الوزن (غ)</label>
            <input id="w_b21" class="num" type="tel" inputmode="decimal" placeholder="">
          </div>
          <div>
            <label>صياغة (0–20 $/غ)</label>
            <input id="add21" class="num" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="">
          </div>
        </div>
        <div id="t_b21" class="tot">الإجمالي: —</div>
      </div>
    </div>
  </section>

  <!-- formulas -->
  <section class="card" style="grid-column:1 / -1">
    <h2>الصيغ المستخدمة</h2>
    <div class="out" style="direction:ltr;text-align:left">
Sell 18K = (oz − 30)/31.1034768 × (740/1000)
Buy  18K = (oz + 30)/31.1034768 × (750/995)
Sell 21K = (oz − 30)/31.1034768 × (865/1000)
Buy  21K = (oz + 30)/31.1034768 × (875/995)
Coin Sell = 8 × Sell21
Coin Buy  = 8 × Sell21 + 8
    </div>
  </section>
</main>

<script>
  // --- API (optional auto-fetch) ---
  const API_KEY = "goldapi-3hvzsmf0w9v53-io";
  const ENDPOINTS = ["https://www.goldapi.io/api/XAU/USD","https://www.goldapi.io/api/price/XAU/USD"];

  // --- helpers ---
  const OZT_TO_G = 31.1034768;
  const $ = id => document.getElementById(id);
  const fmt = n => isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:2}) : "—";
  const cleanDec = s => (s||"").replace(/[^\d.,]/g,"").replace(",",".");
  const fval = id => { const v = parseFloat(cleanDec($(id).value)); return isFinite(v)? v : NaN; };
  const clampInt = (id,min=0,max=20)=>{ const n=parseInt(cleanDec($(id).value),10); return isFinite(n)? Math.min(max,Math.max(min,n)) : NaN; };

  // per-gram prices
  let per = { s18:NaN, b18:NaN, s21:NaN, b21:NaN };

  function calcPerGram(){
    const oz = fval("oz");
    if(!isFinite(oz)||oz<=0) return false;

    per.s18 = ((oz-30)/OZT_TO_G)*(740/1000);
    per.b18 = ((oz+30)/OZT_TO_G)*(750/995);
    per.s21 = ((oz-30)/OZT_TO_G)*(865/1000);
    per.b21 = ((oz+30)/OZT_TO_G)*(875/995);

    $("perg").textContent =
`بيع 18K: $ ${fmt(per.s18)} / غ
شراء 18K: $ ${fmt(per.b18)} / غ
بيع 21K: $ ${fmt(per.s21)} / غ
شراء 21K: $ ${fmt(per.b21)} / غ`;

    const coinSell = 8*per.s21;
    const coinBuy  = 8*per.s21 + 8;
    $("coin").innerHTML = `ليرة — مبيع: $ ${fmt(coinSell)}
ليرة — شراء: $ ${fmt(coinBuy)}
<div class="mini">مبيع = ٨ × بيع ٢١ /غ — شراء = ٨ × بيع ٢١ /غ + ٨ دولار.</div>`;

    $("meta").textContent = "تم الحساب من سعر الأونصة.";
    return true;
  }

  function updateTotals(){
    if(!isFinite(per.s18)) return;

    const ws18=fval("w_s18"); $("t_s18").textContent = "الإجمالي: " + (isFinite(ws18)? "$ "+(per.s18*ws18).toFixed(2) : "—");

    const wb18=fval("w_b18"), a18=clampInt("add18");
    $("t_b18").textContent = "الإجمالي: " + (isFinite(wb18)? "$ "+((per.b18+(isFinite(a18)?a18:0))*wb18).toFixed(2) : "—");

    const ws21=fval("w_s21"); $("t_s21").textContent = "الإجمالي: " + (isFinite(ws21)? "$ "+(per.s21*ws21).toFixed(2) : "—");

    const wb21=fval("w_b21"), a21=clampInt("add21");
    $("t_b21").textContent = "الإجمالي: " + (isFinite(wb21)? "$ "+((per.b21+(isFinite(a21)?a21:0))*wb21).toFixed(2) : "—");
  }

  function runAll(){ if(calcPerGram()) updateTotals(); }

  async function fetchSpot(){
    $("btnFetch").disabled=true; const err=document.getElementById("err"); err.style.display="none"; err.textContent="";
    let last=null;
    for(const url of ENDPOINTS){
      try{
        const r=await fetch(url,{headers:{"x-access-token":API_KEY}});
        if(!r.ok){ last=`HTTP ${r.status} @ ${url}`; continue; }
        const d=await r.json(); const p= typeof d.price==="number"? d.price : (typeof d.price_ounce==="number"? d.price_ounce : NaN);
        if(!isFinite(p)){ last=`No numeric price @ ${url}`; continue; }
        $("oz").value=p.toFixed(2); runAll(); $("btnFetch").disabled=false; return;
      }catch(e){ last=e.message+" @ "+url; }
    }
    err.style.display="block"; err.textContent="فشل الجلب من الـAPI.\n"+last;
    $("btnFetch").disabled=false;
  }

  // live updates
  ["oz","w_s18","w_b18","add18","w_s21","w_b21","add21"].forEach(id=>{
    $(id).addEventListener("input", updateTotals);
  });
  document.getElementById("btnCalc").addEventListener("click", runAll);
  document.getElementById("btnFetch").addEventListener("click", fetchSpot);
  window.addEventListener("load", fetchSpot);
</script>
</body>
</html>